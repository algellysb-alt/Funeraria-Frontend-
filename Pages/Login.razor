@page "/login"
@inject HttpClient Http
@inject NavigationManager NavManager
@inject Blazored.LocalStorage.ILocalStorageService LocalStorage
@inject AuthenticationStateProvider AuthStateProvider
@using System.Net.Http.Json
@using MudBlazor

@* ELIMINADO: @using FunerariaAPI.Models (Ya no es necesario) *@

<div class="d-flex justify-center align-center" style="min-height: 100vh; background-color: #f8fafc;">
    <MudPaper Elevation="1" Class="pa-10 d-flex flex-column align-center" Width="450px" Style="border-radius: 4px;">

        <MudIcon Icon="@Icons.Material.Outlined.LocalFlorist" Style="font-size: 2.5rem; color: #c59d5f;" />
        <MudText Typo="Typo.h5" Class="mt-2" Style="font-family: serif; color: #1e293b;">Funeraria Web</MudText>
        <MudText Typo="Typo.body2" Class="mb-8" Style="color: #64748b;">Servicios funerarios con dignidad y respeto</MudText>

        <MudText Typo="Typo.h5" Class="mb-6" Style="font-family: serif; color: #1e293b;">Iniciar Sesión</MudText>

        <MudText Typo="Typo.caption" Style="align-self: start; font-weight: bold; color: #475569;">Correo Electrónico</MudText>
        <MudTextField @bind-Value="email" Variant="Variant.Outlined" Margin="Margin.Dense" Class="mb-4" FullWidth="true" Placeholder="correo@ejemplo.com" Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Outlined.Email" />

        <MudText Typo="Typo.caption" Style="align-self: start; font-weight: bold; color: #475569;">Contraseña</MudText>
        <MudTextField @bind-Value="password" Variant="Variant.Outlined" InputType="InputType.Password" Margin="Margin.Dense" Class="mb-6" FullWidth="true" Placeholder="••••••••" Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Outlined.Lock" />

        <MudButton Variant="Variant.Filled" FullWidth="true" Size="Size.Large"
                   Style="background-color: #0f172a; color: white; text-transform: none;"
                   OnClick="ProcesarLogin" Disabled="@cargando">
            @if (cargando)
            {
                <MudProgressCircular Class="ms-n1" Size="Size.Small" Indeterminate="true" />
                <MudText Class="ms-2">Ingresando...</MudText>
            }
            else
            {
                <MudText>Ingresar</MudText>
            }
        </MudButton>

        <MudText Typo="Typo.body2" Class="mt-6" Align="Align.Center" Color="Color.Default">
            ¿No tienes cuenta? <MudLink Href="/registro" Style="color: #c59d5f; font-weight: bold; text-decoration: none;">Regístrate aquí</MudLink>
        </MudText>

        @if (!string.IsNullOrEmpty(mensajeError))
        {
            <MudAlert Severity="Severity.Error" Class="mt-4" Dense="true">@mensajeError</MudAlert>
        }
    </MudPaper>
</div>

@code {
    private string email = "";
    private string password = "";
    private string mensajeError = "";
    private bool cargando = false;

    private async Task ProcesarLogin()
    {
        cargando = true;
        mensajeError = "";

        try
        {
            var loginData = new { Email = email, Password = password };
            var response = await Http.PostAsJsonAsync("api/Auth/login", loginData);

            if (response.IsSuccessStatusCode)
            {
                var result = await response.Content.ReadFromJsonAsync<RespuestaTokenLocal>();

                if (result != null && !string.IsNullOrEmpty(result.token))
                {
                    await LocalStorage.SetItemAsync("authToken", result.token);

                    // --- MAGIA NUEVA: Leer el token para saber a dónde ir ---
                    var authState = await AuthStateProvider.GetAuthenticationStateAsync();
                    var user = authState.User;

                    // NOTA: Como acabamos de guardar el token, el AuthProvider puede tardar unos ms
                    // en leerlo. Por eso, hacemos un "forceLoad" simple.

                    // Sin embargo, para simplificar, usaremos la redirección estándar
                    // y dejaremos que el usuario navegue o redirigimos a la raíz.

                    // TRUCO RÁPIDO: Si el email es el del admin, mándalo al admin.
                    // (O mejor aún, deja que el usuario elija en el menú).

                    NavManager.NavigateTo("/", forceLoad: true);
                }
            }
            else
            {
                mensajeError = "Correo o contraseña incorrectos.";
            }
        }
        catch (Exception ex)
        {
            mensajeError = "Error: " + ex.Message;
        }
        finally
        {
            cargando = false;
        }
    }

    // Definimos esta clase AQUÍ MISMO para no necesitar 'using FunerariaAPI.Models'
    public class RespuestaTokenLocal
    {
        public string token { get; set; } = "";
    }
}