@page "/registro"
@inject HttpClient Http
@inject NavigationManager NavManager
@using System.Net.Http.Json
@using MudBlazor

<div class="d-flex justify-center align-center py-10" style="min-height: 100vh; background-color: #f8fafc;">
    <MudPaper Elevation="1" Class="pa-8 d-flex flex-column align-center" Width="500px">
        <MudIcon Icon="@Icons.Material.Outlined.LocalFlorist" Style="font-size: 2rem; color: #c59d5f;" />
        <MudText Typo="Typo.h5" Class="mt-2 mb-1" Style="font-family: serif; color: #1e293b;">Funeraria Web</MudText>
        <MudText Typo="Typo.body2" Class="mb-6" Style="color: #64748b;">Crea tu cuenta para acceder a nuestros servicios</MudText>

        <MudTextField @bind-Value="nombre" Label="Nombre Completo" Variant="Variant.Outlined" Margin="Margin.Dense" Class="mb-3" FullWidth="true" AdornmentIcon="@Icons.Material.Outlined.Person" />
        <MudTextField @bind-Value="email" Label="Correo Electrónico" Variant="Variant.Outlined" Margin="Margin.Dense" Class="mb-3" FullWidth="true" AdornmentIcon="@Icons.Material.Outlined.Email" />
        <MudTextField @bind-Value="password" Label="Contraseña" Variant="Variant.Outlined" InputType="InputType.Password" Margin="Margin.Dense" Class="mb-3" FullWidth="true" AdornmentIcon="@Icons.Material.Outlined.Lock" />
        <MudTextField @bind-Value="telefono" Label="Teléfono" Variant="Variant.Outlined" Margin="Margin.Dense" Class="mb-3" FullWidth="true" AdornmentIcon="@Icons.Material.Outlined.Phone" />
        <MudTextField @bind-Value="direccion" Label="Dirección" Variant="Variant.Outlined" Margin="Margin.Dense" Class="mb-6" FullWidth="true" AdornmentIcon="@Icons.Material.Outlined.Home" />

        <MudButton Variant="Variant.Filled" FullWidth="true" Size="Size.Large"
                   Style="background-color: #0f172a; color: white; text-transform: none;"
                   OnClick="ProcesarRegistro" Disabled="@cargando">
            @(cargando ? "Creando cuenta..." : "Crear Cuenta")
        </MudButton>

        <MudText Typo="Typo.body2" Class="mt-4" Align="Align.Center">
            ¿Ya tienes cuenta? <MudLink Href="/login" Style="color: #c59d5f; font-weight: bold;">Inicia sesión</MudLink>
        </MudText>

        @if (exito) { <MudAlert Severity="Severity.Success" Class="mt-3">¡Cuenta creada! Redirigiendo...</MudAlert> }
        @if (!string.IsNullOrEmpty(mensajeError)) { <MudAlert Severity="Severity.Error" Class="mt-3">@mensajeError</MudAlert> }
    </MudPaper>
</div>

@code {
    string nombre = "", email = "", password = "", telefono = "", direccion = "";
    bool exito = false, cargando = false;
    string mensajeError = "";

    private async Task ProcesarRegistro()
    {
        if (string.IsNullOrEmpty(email) || string.IsNullOrEmpty(password) || string.IsNullOrEmpty(nombre))
        {
            mensajeError = "Por favor completa los campos obligatorios.";
            return;
        }

        cargando = true;
        var nuevoUsuario = new { NombreCompleto = nombre, Email = email, Password = password, Telefono = telefono, Direccion = direccion, Rol = "cliente" };

        try
        {
            // CORRECCIÓN: Usando ruta relativa (BaseAddress de Program.cs)
            var response = await Http.PostAsJsonAsync("api/Auth/registro", nuevoUsuario);

            if (response.IsSuccessStatusCode)
            {
                exito = true;
                StateHasChanged();
                await Task.Delay(2000);
                NavManager.NavigateTo("/login");
            }
            else
            {
                var errorContent = await response.Content.ReadAsStringAsync();
                mensajeError = string.IsNullOrEmpty(errorContent) ? "Error al registrar usuario." : errorContent;
            }
        }
        catch (Exception ex) { mensajeError = "Error de conexión: " + ex.Message; }
        finally { cargando = false; }
    }
}
