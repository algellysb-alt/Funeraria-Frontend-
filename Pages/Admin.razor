@page "/admin"
@using Microsoft.AspNetCore.Authorization
@using System.Net.Http.Json
@using MudBlazor
@using FunerariaWeb.Models

@attribute [Authorize(Roles = "admin")]

@inject HttpClient Http
@inject ISnackbar Snackbar
@inject IDialogService DialogService

<MudContainer MaxWidth="MaxWidth.Large" Class="mt-16 pt-10 pb-16">

    <div class="d-flex justify-space-between align-center mb-6">
        <div>
            <MudText Typo="Typo.h4" Style="font-weight:bold; color:#1e293b;">Panel de Control</MudText>
            <MudText Typo="Typo.subtitle1" Class="mud-text-secondary">Visión general de la funeraria</MudText>
        </div>
        <MudChip T="string" Color="Color.Primary" Icon="@Icons.Material.Filled.AdminPanelSettings">Modo Administrador</MudChip>
    </div>

    <MudGrid Class="mb-8">
        <MudItem xs="12" sm="4">
            <MudPaper Elevation="2" Class="pa-4 d-flex align-center gap-4" Style="border-left: 5px solid #4caf50;">
                <MudAvatar Color="Color.Success" Variant="Variant.Filled" Size="Size.Large">
                    <MudIcon Icon="@Icons.Material.Filled.AttachMoney" Size="Size.Medium" />
                </MudAvatar>
                <div>
                    <MudText Typo="Typo.caption" Class="mud-text-secondary">INGRESOS ESTIMADOS</MudText>
                    <MudText Typo="Typo.h5" Style="font-weight:bold;">RD$ @TotalIngresos.ToString("N2")</MudText>
                </div>
            </MudPaper>
        </MudItem>
        <MudItem xs="12" sm="4">
            <MudPaper Elevation="2" Class="pa-4 d-flex align-center gap-4" Style="border-left: 5px solid #2196f3;">
                <MudAvatar Color="Color.Info" Variant="Variant.Filled" Size="Size.Large">
                    <MudIcon Icon="@Icons.Material.Filled.ShoppingBag" Size="Size.Medium" />
                </MudAvatar>
                <div>
                    <MudText Typo="Typo.caption" Class="mud-text-secondary">PEDIDOS TOTALES</MudText>
                    <MudText Typo="Typo.h5" Style="font-weight:bold;">@TotalPedidos</MudText>
                </div>
            </MudPaper>
        </MudItem>
        <MudItem xs="12" sm="4">
            <MudPaper Elevation="2" Class="pa-4 d-flex align-center gap-4" Style="border-left: 5px solid #ff9800;">
                <MudAvatar Color="Color.Warning" Variant="Variant.Filled" Size="Size.Large">
                    <MudIcon Icon="@Icons.Material.Filled.People" Size="Size.Medium" />
                </MudAvatar>
                <div>
                    <MudText Typo="Typo.caption" Class="mud-text-secondary">CLIENTES ACTIVOS</MudText>
                    <MudText Typo="Typo.h5" Style="font-weight:bold;">@TotalUsuarios</MudText>
                </div>
            </MudPaper>
        </MudItem>
    </MudGrid>

    <MudPaper Elevation="2" Class="pa-4">
        <MudTabs Elevation="0" Rounded="true" ApplyEffectsToContainer="true" PanelClass="pt-6">

            <MudTabPanel Text="Pedidos por Cliente" Icon="@Icons.Material.Filled.ListAlt">

                <MudTable Items="@listaPedidos" Hover="true" Breakpoint="Breakpoint.Sm" Dense="true"
                          GroupBy="@groupBy" GroupHeaderStyle="background-color:#f1f5f9; font-weight:bold;">

                    <HeaderContent>
                        <MudTh>ID</MudTh>
                        <MudTh>Difunto</MudTh>
                        <MudTh>Fecha Servicio</MudTh>
                        <MudTh>Estado</MudTh>
                        <MudTh>Total</MudTh>
                        <MudTh>Acciones</MudTh>
                    </HeaderContent>

                    <GroupHeaderTemplate>
                        <MudTh Class="mud-table-cell-custom-group" colspan="6">
                            <div class="d-flex align-center">
                                <MudIcon Icon="@Icons.Material.Filled.Person" Color="Color.Primary" Size="Size.Small" Class="mr-2" />
                                <MudText Typo="Typo.subtitle1" Color="Color.Primary">
                                    <b>@context.Key</b>
                                </MudText>
                                <MudChip T="string" Size="Size.Small" Class="ml-3" Variant="Variant.Outlined">
                                    @context.Items.Count() pedidos
                                </MudChip>
                            </div>
                        </MudTh>
                    </GroupHeaderTemplate>

                    <RowTemplate>
                        <MudTd DataLabel="ID"><b>#@context.id</b></MudTd>
                        <MudTd DataLabel="Difunto">@context.nombreDifunto</MudTd>
                        <MudTd DataLabel="Fecha">@context.fechaServicio.ToShortDateString()</MudTd>
                        <MudTd DataLabel="Estado">
                            <MudChip T="string" Color="@ObtenerColor(context.estado)" Size="Size.Small" Variant="Variant.Filled">
                                @(context.estado?.ToUpper() ?? "N/A")
                            </MudChip>
                        </MudTd>
                        <MudTd DataLabel="Total">RD$ @context.totalEstimado.ToString("N2")</MudTd>
                        <MudTd>
                            <MudIconButton Icon="@Icons.Material.Filled.Edit" Color="Color.Default" Size="Size.Small" OnClick="@(() => AbrirEdicion(context))" />
                        </MudTd>
                    </RowTemplate>

                    <GroupFooterTemplate>
                        <MudTh Class="mud-table-cell-custom-group" colspan="6" Style="text-align: right; background-color: #fafafa;">
                            Total de @context.Key: <b style="color:#2e7d32;">RD$ @context.Items.Sum((x) => x.totalEstimado).ToString("N2")</b>
                        </MudTh>
                    </GroupFooterTemplate>
                </MudTable>
            </MudTabPanel>

            <MudTabPanel Text="Directorio de Clientes" Icon="@Icons.Material.Filled.Contacts">
                <MudTable Items="@listaUsuarios" Hover="true" Striped="true" Elevation="0">
                    <HeaderContent>
                        <MudTh>Nombre</MudTh>
                        <MudTh>Email</MudTh>
                        <MudTh>Rol</MudTh>
                        <MudTh>Acciones</MudTh>
                    </HeaderContent>
                    <RowTemplate>
                        <MudTd DataLabel="Nombre">
                            <div class="d-flex align-center">
                                <MudAvatar Size="Size.Small" Color="Color.Secondary" Class="mr-2">@context.NombreCompleto.Substring(0, 1).ToUpper()</MudAvatar>
                                @context.NombreCompleto
                            </div>
                        </MudTd>
                        <MudTd DataLabel="Email">@context.Email</MudTd>
                        <MudTd DataLabel="Rol">
                            <MudChip T="string" Color="@(context.Rol == "admin" ? Color.Warning : Color.Success)" Size="Size.Small">@context.Rol</MudChip>
                        </MudTd>
                        <MudTd>
                            <MudIconButton Icon="@Icons.Material.Filled.Delete" Color="Color.Error" Size="Size.Small" OnClick="@(() => BorrarUsuario(context))" />
                        </MudTd>
                    </RowTemplate>
                </MudTable>
            </MudTabPanel>

            <MudTabPanel Text="Estadísticas" Icon="@Icons.Material.Filled.PieChart">
                <div class="d-flex justify-center py-8">
                    @if (datosGrafica.Any())
                    {
                        <MudPaper Class="pa-6 text-center" Elevation="0">
                            <MudText Typo="Typo.h6" Class="mb-4">Estado de los Pedidos</MudText>
                            <MudChart ChartType="ChartType.Donut" Width="300px" Height="300px" InputData="@datosGrafica" InputLabels="@etiquetasGrafica" />
                        </MudPaper>
                    }
                    else
                    {
                        <MudAlert Severity="Severity.Info">No hay suficientes datos para mostrar gráficas.</MudAlert>
                    }
                </div>
            </MudTabPanel>

        </MudTabs>
    </MudPaper>

</MudContainer>

@code {
    // --- VARIABLES DE DATOS ---
    private List<PedidoAdmin> listaPedidos = new List<PedidoAdmin>();
    private List<UsuarioDto> listaUsuarios = new List<UsuarioDto>();

    // --- VARIABLES DE ESTADÍSTICAS ---
    private decimal TotalIngresos = 0;
    private int TotalPedidos = 0;
    private int TotalUsuarios = 0;

    // --- VARIABLES PARA GRÁFICA ---
    public double[] datosGrafica = { };
    public string[] etiquetasGrafica = { };

    // --- AGRUPACIÓN POR CLIENTE ---
    private TableGroupDefinition<PedidoAdmin> groupBy = new()
    {
        GroupName = "Cliente",
        Indentation = false,
        Expandable = true,
        IsInitiallyExpanded = true,
        Selector = (e) => e.usuario?.nombreCompleto ?? "Sin Nombre" // Protección contra nulos
    };

    protected override async Task OnInitializedAsync()
    {
        await CargarDatos();
    }

    private async Task CargarDatos()
    {
        try
        {
            // 1. CARGAR PEDIDOS
            var pedidosArray = await Http.GetFromJsonAsync<PedidoAdmin[]>("https://localhost:7051/api/Pedidos/todos");
            if (pedidosArray != null)
            {
                listaPedidos = pedidosArray.ToList();
                TotalIngresos = listaPedidos.Sum(p => p.totalEstimado);
                TotalPedidos = listaPedidos.Count;

                // Datos para gráfica
                var grupos = listaPedidos.GroupBy(p => p.estado).Select(g => new { Estado = g.Key, Cantidad = g.Count() }).ToList();
                datosGrafica = grupos.Select(x => (double)x.Cantidad).ToArray();
                etiquetasGrafica = grupos.Select(x => (x.Estado ?? "N/A").ToUpper()).ToArray();
            }

            // 2. CARGAR USUARIOS
            var usuariosArray = await Http.GetFromJsonAsync<UsuarioDto[]>("https://localhost:7051/api/Usuarios");
            if (usuariosArray != null)
            {
                listaUsuarios = usuariosArray.ToList();
                TotalUsuarios = listaUsuarios.Count;
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add("Nota: Asegúrate de ser admin y que la API esté corriendo.", Severity.Warning);
        }
    }

    private Color ObtenerColor(string? estado) => (estado ?? "").ToLower() switch
    {
        "pendiente" => Color.Warning,
        "aprobado" => Color.Success,
        "confirmado" => Color.Success,
        "en_proceso" => Color.Info,
        "finalizado" => Color.Primary,
        "cancelado" => Color.Error,
        _ => Color.Default
    };

    private async Task AbrirEdicion(PedidoAdmin pedido)
    {
        var parameters = new DialogParameters { ["Pedido"] = pedido };
        var options = new DialogOptions { MaxWidth = MaxWidth.Small, FullWidth = true };
        var dialog = DialogService.Show<DialogoAdminPedido>("Gestionar Pedido", parameters, options);
        var result = await dialog.Result;
        if (!result.Canceled) await CargarDatos();
    }

    private async Task BorrarUsuario(UsuarioDto user)
    {
        bool? result = await DialogService.ShowMessageBox("Advertencia", $"¿Estás seguro de eliminar a {user.NombreCompleto}?", yesText: "Eliminar", cancelText: "Cancelar");
        if (result == true)
        {
            await Http.DeleteAsync($"https://localhost:7051/api/Usuarios/{user.Id}");
            await CargarDatos();
        }
    }

    public class UsuarioDto
    {
        public int Id { get; set; }
        public string NombreCompleto { get; set; } = "";
        public string Email { get; set; } = "";
        public string Rol { get; set; } = "";
    }
}