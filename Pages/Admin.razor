@page "/admin"
@using Microsoft.AspNetCore.Authorization
@using System.Net.Http.Json
@using MudBlazor
@using FunerariaWeb.Models

@attribute [Authorize(Roles = "admin")]

@inject HttpClient Http
@inject ISnackbar Snackbar
@inject IDialogService DialogService

<MudContainer MaxWidth="MaxWidth.Large" Class="mt-16 pt-10 pb-16">
    <div class="d-flex justify-space-between align-center mb-6">
        <div>
            <MudText Typo="Typo.h4" Style="font-weight:bold; color:#1e293b;">Panel de Control</MudText>
            <MudText Typo="Typo.subtitle1" Class="mud-text-secondary">Visión general de la funeraria</MudText>
        </div>
        <MudChip T="string" Color="Color.Primary" Icon="@Icons.Material.Filled.AdminPanelSettings">Modo Administrador</MudChip>
    </div>

    @* --- TARJETAS DE ESTADÍSTICAS --- *@
    <MudGrid Class="mb-8">
        <MudItem xs="12" sm="4">
            <MudPaper Elevation="2" Class="pa-4 d-flex align-center gap-4" Style="border-left: 5px solid #4caf50;">
                <MudAvatar Color="Color.Success" Variant="Variant.Filled" Size="Size.Large">
                    <MudIcon Icon="@Icons.Material.Filled.AttachMoney" Size="Size.Medium" />
                </MudAvatar>
                <div>
                    <MudText Typo="Typo.caption" Class="mud-text-secondary">INGRESOS ESTIMADOS</MudText>
                    <MudText Typo="Typo.h5" Style="font-weight:bold;">RD$ @TotalIngresos.ToString("N2")</MudText>
                </div>
            </MudPaper>
        </MudItem>
        <MudItem xs="12" sm="4">
            <MudPaper Elevation="2" Class="pa-4 d-flex align-center gap-4" Style="border-left: 5px solid #2196f3;">
                <MudAvatar Color="Color.Info" Variant="Variant.Filled" Size="Size.Large">
                    <MudIcon Icon="@Icons.Material.Filled.ShoppingBag" Size="Size.Medium" />
                </MudAvatar>
                <div>
                    <MudText Typo="Typo.caption" Class="mud-text-secondary">PEDIDOS TOTALES</MudText>
                    <MudText Typo="Typo.h5" Style="font-weight:bold;">@TotalPedidos</MudText>
                </div>
            </MudPaper>
        </MudItem>
        <MudItem xs="12" sm="4">
            <MudPaper Elevation="2" Class="pa-4 d-flex align-center gap-4" Style="border-left: 5px solid #ff9800;">
                <MudAvatar Color="Color.Warning" Variant="Variant.Filled" Size="Size.Large">
                    <MudIcon Icon="@Icons.Material.Filled.People" Size="Size.Medium" />
                </MudAvatar>
                <div>
                    <MudText Typo="Typo.caption" Class="mud-text-secondary">CLIENTES ACTIVOS</MudText>
                    <MudText Typo="Typo.h5" Style="font-weight:bold;">@TotalUsuarios</MudText>
                </div>
            </MudPaper>
        </MudItem>
    </MudGrid>

    <MudPaper Elevation="2" Class="pa-4">
        <MudTabs Elevation="0" Rounded="true" ApplyEffectsToContainer="true" PanelClass="pt-6">

            @* TABLA DE PEDIDOS *@
            <MudTabPanel Text="Pedidos por Cliente" Icon="@Icons.Material.Filled.ListAlt">
                <MudTable Items="@listaPedidos" Hover="true" Breakpoint="Breakpoint.Sm" Dense="true"
                          GroupBy="@groupBy" GroupHeaderStyle="background-color:#f1f5f9; font-weight:bold;">
                    <HeaderContent>
                        <MudTh>ID</MudTh>
                        <MudTh>Difunto</MudTh>
                        <MudTh>Fecha Servicio</MudTh>
                        <MudTh>Estado</MudTh>
                        <MudTh>Total</MudTh>
                        <MudTh>Acciones</MudTh>
                    </HeaderContent>
                    <GroupHeaderTemplate>
                        <MudTh Class="mud-table-cell-custom-group" colspan="6">
                            <div class="d-flex align-center">
                                <MudIcon Icon="@Icons.Material.Filled.Person" Color="Color.Primary" Size="Size.Small" Class="mr-2" />
                                <MudText Typo="Typo.subtitle1" Color="Color.Primary"><b>@context.Key</b></MudText>
                                <MudChip T="string" Size="Size.Small" Class="ml-3" Variant="Variant.Outlined">@context.Items.Count() pedidos</MudChip>
                            </div>
                        </MudTh>
                    </GroupHeaderTemplate>
                    <RowTemplate>
                        <MudTd DataLabel="ID"><b>#@context.id</b></MudTd>
                        <MudTd DataLabel="Difunto">@context.nombreDifunto</MudTd>
                        <MudTd DataLabel="Fecha">@context.fechaServicio.ToShortDateString()</MudTd>
                        <MudTd DataLabel="Estado">
                            <MudChip T="string" Color="@ObtenerColor(context.estado)" Size="Size.Small" Variant="Variant.Filled">
                                @(context.estado?.ToUpper() ?? "N/A")
                            </MudChip>
                        </MudTd>
                        <MudTd DataLabel="Total">RD$ @context.totalEstimado.ToString("N2")</MudTd>
                        <MudTd>
                            <MudIconButton Icon="@Icons.Material.Filled.Edit" Color="Color.Default" Size="Size.Small" OnClick="@(() => AbrirEdicion(context))" />
                        </MudTd>
                    </RowTemplate>
                </MudTable>
            </MudTabPanel>

            @* DIRECTORIO DE CLIENTES *@
            <MudTabPanel Text="Directorio de Clientes" Icon="@Icons.Material.Filled.Contacts">
                <MudTable Items="@listaUsuarios" Hover="true" Striped="true" Elevation="0">
                    <HeaderContent>
                        <MudTh>Nombre</MudTh>
                        <MudTh>Email</MudTh>
                        <MudTh>Rol</MudTh>
                        <MudTh>Acciones</MudTh>
                    </HeaderContent>
                    <RowTemplate>
                        <MudTd DataLabel="Nombre">@context.NombreCompleto</MudTd>
                        <MudTd DataLabel="Email">@context.Email</MudTd>
                        <MudTd DataLabel="Rol">
                            <MudChip T="string" Color="@(context.Rol == "admin" ? Color.Warning : Color.Success)" Size="Size.Small">@context.Rol</MudChip>
                        </MudTd>
                        <MudTd>
                            <MudIconButton Icon="@Icons.Material.Filled.Delete" Color="Color.Error" Size="Size.Small" OnClick="@(() => BorrarUsuario(context))" />
                        </MudTd>
                    </RowTemplate>
                </MudTable>
            </MudTabPanel>
        </MudTabs>
    </MudPaper>
</MudContainer>

@code {
    private List<PedidoAdmin> listaPedidos = new();
    private List<UsuarioDto> listaUsuarios = new();
    private decimal TotalIngresos = 0;
    private int TotalPedidos = 0;
    private int TotalUsuarios = 0;

    private TableGroupDefinition<PedidoAdmin> groupBy = new()
    {
        Selector = (e) => e.usuario?.nombreCompleto ?? "Sin Nombre"
    };

    protected override async Task OnInitializedAsync() => await CargarDatos();

    private async Task CargarDatos()
    {
        try
        {
            // USANDO RUTAS RELATIVAS (RUTA DE PROGRAM.CS)
            var pedidos = await Http.GetFromJsonAsync<PedidoAdmin[]>("api/Pedidos/todos");
            if (pedidos != null)
            {
                listaPedidos = pedidos.ToList();
                TotalIngresos = listaPedidos.Sum(p => p.totalEstimado);
                TotalPedidos = listaPedidos.Count;
            }

            var usuarios = await Http.GetFromJsonAsync<UsuarioDto[]>("api/Usuarios");
            if (usuarios != null)
            {
                listaUsuarios = usuarios.ToList();
                TotalUsuarios = listaUsuarios.Count;
            }
        }
        catch (Exception) { Snackbar.Add("Error al cargar datos desde la API", Severity.Error); }
    }

    private Color ObtenerColor(string? estado) => (estado ?? "").ToLower() switch
    {
        "pendiente" => Color.Warning,
        "aprobado" => Color.Success,
        "finalizado" => Color.Primary,
        "cancelado" => Color.Error,
        _ => Color.Default
    };

    private async Task AbrirEdicion(PedidoAdmin pedido)
    {
        var parameters = new DialogParameters { ["Pedido"] = pedido };
        var dialog = DialogService.Show<DialogoAdminPedido>("Gestionar", parameters);
        var result = await dialog.Result;
        if (!result.Canceled) await CargarDatos();
    }

    private async Task BorrarUsuario(UsuarioDto user)
    {
        var result = await DialogService.ShowMessageBox("Borrar", "¿Confirmar?", yesText: "Sí", noText: "No");
        if (result == true)
        {
            await Http.DeleteAsync($"api/Usuarios/{user.Id}");
            await CargarDatos();
        }
    }

    public class UsuarioDto { public int Id { get; set; } public string NombreCompleto { get; set; } = ""; public string Email { get; set; } = ""; public string Rol { get; set; } = ""; }
}
