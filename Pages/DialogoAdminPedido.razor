@using MudBlazor
@using System.Net.Http.Json
@using FunerariaWeb.Models

@inject HttpClient Http
@inject ISnackbar Snackbar

<MudDialog>
    <DialogContent>
        <MudText Typo="Typo.h6">Gestionar Pedido #@Pedido.id</MudText>
        <MudDivider Class="my-2" />

        <MudText><b>Difunto:</b> @Pedido.nombreDifunto</MudText>
        <MudText><b>Total:</b> RD$ @Pedido.totalEstimado.ToString("N2")</MudText>

        <MudText Class="mt-4 mb-2"><b>Estado Actual:</b></MudText>

        <MudSelect T="string" @bind-Value="nuevoEstado" Variant="Variant.Outlined" AnchorOrigin="Origin.BottomCenter">
            <MudSelectItem Value="@("pendiente")">Pendiente</MudSelectItem>
            <MudSelectItem Value="@("confirmado")">Confirmado</MudSelectItem>
            <MudSelectItem Value="@("en_proceso")">En Proceso</MudSelectItem>
            <MudSelectItem Value="@("finalizado")">Finalizado</MudSelectItem>
            <MudSelectItem Value="@("cancelado")">Cancelado</MudSelectItem>
        </MudSelect>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel">Cancelar</MudButton>
        <MudButton Color="Color.Primary" Variant="Variant.Filled" OnClick="GuardarCambios">Guardar</MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] MudDialogInstance MudDialog { get; set; } = default!;

    [Parameter] public PedidoAdmin Pedido { get; set; } = new();

    private string nuevoEstado = "";

    protected override void OnInitialized()
    {
        // Si viene nulo, ponemos "pendiente"
        nuevoEstado = Pedido.estado ?? "pendiente";
    }

    private void Cancel() => MudDialog.Cancel();

    private async Task GuardarCambios()
    {
        try
        {
            // Enviamos el cambio a la API
            var response = await Http.PutAsJsonAsync($"https://localhost:7051/api/Pedidos/{Pedido.id}/estado", nuevoEstado);

            if (response.IsSuccessStatusCode)
            {
                Snackbar.Add("Estado actualizado correctamente", Severity.Success);
                MudDialog.Close(DialogResult.Ok(true));
            }
            else
            {
                Snackbar.Add("Error al actualizar el estado", Severity.Error);
            }
        }
        catch (Exception)
        {
            Snackbar.Add("Error de conexión con el servidor", Severity.Error);
        }
    }
}