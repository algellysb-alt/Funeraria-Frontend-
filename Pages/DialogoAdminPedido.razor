@using MudBlazor
@using System.Net.Http.Json
@using FunerariaWeb.Models

@inject HttpClient Http
@inject ISnackbar Snackbar

<MudDialog>
    <DialogContent>
        <MudText Typo="Typo.h6">Pedido #@Pedido.id</MudText>
        <MudText Class="mud-text-secondary">Difunto: @Pedido.nombreDifunto</MudText>
        
        <MudSelect T="string" Label="Cambiar Estado" @bind-Value="nuevoEstado" Class="mt-4" Variant="Variant.Outlined">
            <MudSelectItem Value="@("pendiente")">Pendiente</MudSelectItem>
            <MudSelectItem Value="@("confirmado")">Confirmado</MudSelectItem>
            <MudSelectItem Value="@("finalizado")">Finalizado</MudSelectItem>
            <MudSelectItem Value="@("cancelado")">Cancelado</MudSelectItem>
        </MudSelect>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel">Cerrar</MudButton>
        <MudButton Color="Color.Primary" Variant="Variant.Filled" OnClick="GuardarCambios">Actualizar</MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] MudDialogInstance MudDialog { get; set; } = default!;
    [Parameter] public PedidoAdmin Pedido { get; set; } = new();
    private string nuevoEstado = "";

    protected override void OnInitialized() => nuevoEstado = Pedido.estado ?? "pendiente";

    private void Cancel() => MudDialog.Cancel();

    private async Task GuardarCambios()
    {
        try
        {
            // USANDO RUTA RELATIVA (PROGRAM.CS)
            var response = await Http.PutAsJsonAsync($"api/Pedidos/{Pedido.id}/estado", nuevoEstado);

            if (response.IsSuccessStatusCode)
            {
                Snackbar.Add("Estado actualizado", Severity.Success);
                MudDialog.Close(DialogResult.Ok(true));
            }
        }
        catch (Exception) { Snackbar.Add("Error de conexi√≥n", Severity.Error); }
    }
}
