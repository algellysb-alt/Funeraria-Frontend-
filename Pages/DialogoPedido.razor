@using MudBlazor
@using FunerariaWeb.Models
@inject HttpClient Http
@inject ISnackbar Snackbar

<MudDialog>
    <DialogContent>
        <MudGrid>
            <MudItem xs="12" md="6">
                <MudText Typo="Typo.h6" Class="mb-2">Tu Carrito üõí</MudText>
                <MudPaper Class="pa-2" Elevation="0" Outlined="true" Style="max-height: 300px; overflow-y: auto;">
                    @if (ProductosSeleccionados.Count == 0)
                    {
                        <MudText Typo="Typo.body2" Class="pa-4 text-center">El carrito est√° vac√≠o.</MudText>
                    }
                    else
                    {
                        <MudList T="ProductoCliente" Dense="true">
                            @foreach (var item in ProductosSeleccionados.ToList())
                            {
                                <MudListItem Icon="@Icons.Material.Filled.LocalOffer" IconColor="Color.Secondary">
                                    <div class="d-flex justify-space-between align-center">
                                        <div>
                                            <MudText Typo="Typo.body2">@item.Nombre</MudText>
                                            <MudText Typo="Typo.caption">RD$ @item.Precio.ToString("N2")</MudText>
                                        </div>
                                        <MudIconButton Icon="@Icons.Material.Filled.Delete" Color="Color.Error" Size="Size.Small"
                                                       OnClick="@(() => EliminarProducto(item))" />
                                    </div>
                                </MudListItem>
                                <MudDivider />
                            }
                        </MudList>
                    }
                </MudPaper>
                <div class="d-flex justify-space-between mt-3 pa-2" style="background-color:#f1f5f9; border-radius:4px;">
                    <MudText Typo="Typo.subtitle1"><b>Total:</b></MudText>
                    <MudText Typo="Typo.h6" Color="Color.Primary"><b>RD$ @ProductosSeleccionados.Sum(p => p.Precio).ToString("N2")</b></MudText>
                </div>
            </MudItem>

            <MudItem xs="12" md="6">
                <MudText Typo="Typo.h6" Class="mb-2">Datos del Servicio üìù</MudText>
                <EditForm Model="@pedidoDto" OnValidSubmit="EnviarPedido">
                    <DataAnnotationsValidator />
                    <MudTextField @bind-Value="pedidoDto.NombreDifunto" Label="Nombre del Difunto"
                                  Variant="Variant.Outlined" Margin="Margin.Dense" Class="mb-3" Required="true" />
                    <MudDatePicker @bind-Date="fechaNullable" Label="Fecha del Servicio"
                                   Variant="Variant.Outlined" Margin="Margin.Dense" Class="mb-3" />
                    <MudTextField @bind-Value="pedidoDto.Notas" Label="Notas Adicionales"
                                  Variant="Variant.Outlined" Lines="3" Margin="Margin.Dense" />
                    <div class="d-flex justify-end mt-6">
                        <MudButton OnClick="Cancel" Color="Color.Default" Class="mr-2">Cancelar</MudButton>
                        <MudButton ButtonType="ButtonType.Submit" Variant="Variant.Filled" Color="Color.Secondary"
                                   Disabled="@(procesando || ProductosSeleccionados.Count == 0)" StartIcon="@Icons.Material.Filled.Check">
                            @(procesando ? "Enviando..." : "Confirmar")
                        </MudButton>
                    </div>
                </EditForm>
            </MudItem>
        </MudGrid>
    </DialogContent>
</MudDialog>

@code {
    [CascadingParameter] MudDialogInstance MudDialog { get; set; } = default!;
    [Parameter] public List<ProductoCliente> ProductosSeleccionados { get; set; } = new();

    private CrearPedidoDto pedidoDto = new();
    private DateTime? fechaNullable = DateTime.Now.AddDays(1);
    private bool procesando = false;

    private void Cancel() => MudDialog.Cancel();

    private void EliminarProducto(ProductoCliente item)
    {
        ProductosSeleccionados.Remove(item);
        StateHasChanged();
    }

    private async Task EnviarPedido()
    {
        procesando = true;
        pedidoDto.FechaServicio = fechaNullable ?? DateTime.Now;
        pedidoDto.Items = ProductosSeleccionados.Select(p => new DetallePedidoDto { ProductoId = p.Id, Cantidad = 1 }).ToList();

        try
        {
            // CORRECCI√ìN: Usando ruta relativa de Program.cs
            var response = await Http.PostAsJsonAsync("api/Pedidos", pedidoDto);

            if (response.IsSuccessStatusCode)
            {
                Snackbar.Add("¬°Pedido creado con √©xito!", Severity.Success);
                MudDialog.Close(DialogResult.Ok(true));
            }
            else
            {
                Snackbar.Add("Error al crear el pedido.", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add("Error de conexi√≥n: " + ex.Message, Severity.Error);
        }
        finally { procesando = false; }
    }
}
