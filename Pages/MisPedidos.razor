@page "/mis-pedidos"
@using Microsoft.AspNetCore.Authorization
@using System.Net.Http.Json
@using MudBlazor
@using FunerariaWeb.Models

@attribute [Authorize]
@inject HttpClient Http
@inject NavigationManager Nav

<MudContainer MaxWidth="MaxWidth.Large" Class="pt-16 mt-10">

    <MudText Typo="Typo.h4" Class="mb-4" Style="font-family: serif; color: #1e293b;">
        Rastreo de Servicios 🚚
    </MudText>

    @if (cargando)
    {
        <MudProgressLinear Color="Color.Secondary" Indeterminate="true" Class="my-5" />
    }
    else if (pedidos == null || !pedidos.Any())
    {
        <MudAlert Severity="Severity.Info" Variant="Variant.Outlined" Class="mt-4">
            No tienes servicios activos en este momento. <MudLink Href="cliente">Ir al catálogo</MudLink>
        </MudAlert>
    }
    else
    {
        <MudTable Items="@pedidos" Hover="true" Breakpoint="Breakpoint.Sm" Elevation="3">
            <HeaderContent>
                <MudTh># Pedido</MudTh>
                <MudTh>Difunto</MudTh>
                <MudTh>Fecha Servicio</MudTh>
                <MudTh>Estado Actual</MudTh>
                <MudTh>Monto</MudTh>
                <MudTh></MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd DataLabel="ID">@context.Id</MudTd>
                <MudTd DataLabel="Difunto">@context.NombreDifunto</MudTd>
                <MudTd DataLabel="Fecha">@context.FechaServicio.ToShortDateString()</MudTd>
                <MudTd DataLabel="Estado">
                    <MudChip T="string" Color="@ObtenerColorEstado(context.Estado)" Size="Size.Small" Icon="@ObtenerIconoEstado(context.Estado)">
                        @context.Estado.ToUpper()
                    </MudChip>
                </MudTd>
                <MudTd DataLabel="Total">RD$ @context.TotalEstimado.ToString("N2")</MudTd>
                <MudTd>
                    <MudIconButton Icon="@Icons.Material.Filled.KeyboardArrowDown" Size="Size.Small" />
                </MudTd>
            </RowTemplate>

            <ChildRowContent>
                <MudTr>
                    <td colspan="6">
                        <MudCard Elevation="0" Class="pa-4" Style="background-color: #f8fafc;">
                            <MudText Typo="Typo.subtitle2" Class="mb-3">Progreso del Servicio:</MudText>

                            <MudTimeline Orientation="Orientation.Horizontal" TimelinePosition="TimelinePosition.Bottom">

                                <MudTimelineItem Color="Color.Info" Variant="Variant.Filled">
                                    <ItemContent>
                                        <MudText Typo="Typo.button">Solicitado</MudText>
                                        <MudText Typo="Typo.caption">Recibido en sistema</MudText>
                                    </ItemContent>
                                </MudTimelineItem>

                                <MudTimelineItem Color="@(EsPasoCompletado(context.Estado, 2) ? Color.Success : Color.Default)" Variant="Variant.Filled">
                                    <ItemContent>
                                        <MudText Typo="Typo.button">Aprobado</MudText>
                                        <MudText Typo="Typo.caption">Confirmado por admin</MudText>
                                    </ItemContent>
                                </MudTimelineItem>

                                <MudTimelineItem Color="@(EsPasoCompletado(context.Estado, 3) ? Color.Warning : Color.Default)" Variant="Variant.Filled">
                                    <ItemContent>
                                        <MudText Typo="Typo.button">En Proceso</MudText>
                                        <MudText Typo="Typo.caption">Servicio en curso</MudText>
                                    </ItemContent>
                                </MudTimelineItem>

                                <MudTimelineItem Color="@(EsPasoCompletado(context.Estado, 4) ? Color.Primary : Color.Default)" Variant="Variant.Filled">
                                    <ItemContent>
                                        <MudText Typo="Typo.button">Finalizado</MudText>
                                        <MudText Typo="Typo.caption">Servicio concluido</MudText>
                                    </ItemContent>
                                </MudTimelineItem>

                            </MudTimeline>

                            @if (!string.IsNullOrEmpty(context.NotasAdicionales))
                            {
                                <MudAlert Severity="Severity.Info" Dense="true" Class="mt-3">Nota: @context.NotasAdicionales</MudAlert>
                            }
                        </MudCard>
                    </td>
                </MudTr>
            </ChildRowContent>
        </MudTable>
    }
</MudContainer>

@code {
    // Modelo local para recibir datos (debe coincidir con la API)
    public class PedidoResumenDto
    {
        public int Id { get; set; }
        public string NombreDifunto { get; set; } = "";
        public DateTime FechaServicio { get; set; }
        public string Estado { get; set; } = ""; // pendiente, aprobado, proceso, completado
        public decimal TotalEstimado { get; set; }
        public string NotasAdicionales { get; set; } = "";
    }

    private List<PedidoResumenDto>? pedidos;
    private bool cargando = true;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            // Llama a tu API segura. El token va automático.
            pedidos = await Http.GetFromJsonAsync<List<PedidoResumenDto>>("api/Pedidos");
        }
        catch (Exception ex)
        {
            Console.WriteLine("Error: " + ex.Message);
        }
        finally
        {
            cargando = false;
        }
    }

    // Lógica para colorear los pasos del Timeline
    private bool EsPasoCompletado(string estadoActual, int pasoRequerido)
    {
        int nivelActual = estadoActual.ToLower() switch
        {
            "pendiente" => 1,
            "aprobado" => 2,
            "proceso" => 3, // O "en proceso" según guardes en BD
            "completado" => 4,
            _ => 0
        };
        return nivelActual >= pasoRequerido;
    }

    private Color ObtenerColorEstado(string estado)
    {
        return estado.ToLower() switch
        {
            "pendiente" => Color.Warning,
            "aprobado" => Color.Success,
            "proceso" => Color.Info,
            "completado" => Color.Primary,
            "cancelado" => Color.Error,
            _ => Color.Default
        };
    }

    private string ObtenerIconoEstado(string estado)
    {
        return estado.ToLower() switch
        {
            "pendiente" => Icons.Material.Filled.AccessTime,
            "aprobado" => Icons.Material.Filled.CheckCircle,
            "proceso" => Icons.Material.Filled.RunCircle,
            "completado" => Icons.Material.Filled.Flag,
            _ => Icons.Material.Filled.Info
        };
    }
}